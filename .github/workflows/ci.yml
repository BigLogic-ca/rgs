name: CI

on:
 push:
  branches: [main, develop]
 pull_request:
  branches: [main, develop]

concurrency:
 group: ${{ github.workflow }}-${{ github.ref }}
 cancel-in-progress: true

jobs:
 secrets-scan:
  name: Secrets Scan
  runs-on: ubuntu-latest
  steps:
   - name: Checkout repository
     uses: actions/checkout@v4

   - name: Run GitLeaks
     uses: gitleaks/gitleaks-action@v2
     env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GITLEAKS_CONFIG_PATH: .github/gitleaks.toml

 lint:
  name: Lint
  runs-on: ubuntu-latest
  needs: secrets-scan
  steps:
   - name: Checkout repository
     uses: actions/checkout@v4

   - name: Setup Node.js
     uses: actions/setup-node@v4
     with:
      node-version: "20"
      cache: "npm"

   - name: Install dependencies
     run: npm ci

   - name: Run ESLint
     run: npm run eslint

   - name: Run TypeScript check
     run: npm run tsc

 test:
  name: Test
  runs-on: ubuntu-latest
  needs: lint
  steps:
   - name: Checkout repository
     uses: actions/checkout@v4

   - name: Setup Node.js
     uses: actions/setup-node@v4
     with:
      node-version: "20"
      cache: "npm"

   - name: Install dependencies
     run: npm ci

   - name: Install test dependencies
     working-directory: ./tests
     run: npm ci

   - name: Run tests
     working-directory: ./tests
     run: npm test

   - name: Upload coverage
     uses: actions/upload-artifact@v4
     if: always()
     with:
      name: coverage
      path: tests/coverage
      retention-days: 7

 build:
  name: Build
  runs-on: ubuntu-latest
  needs: test
  steps:
   - name: Checkout repository
     uses: actions/checkout@v4

   - name: Setup Node.js
     uses: actions/setup-node@v4
     with:
      node-version: "20"
      cache: "npm"

   - name: Install dependencies
     run: npm ci

   - name: Build package
     run: npm run build

   - name: Upload build artifacts
     uses: actions/upload-artifact@v4
     with:
      name: dist
      path: dist
      retention-days: 7
